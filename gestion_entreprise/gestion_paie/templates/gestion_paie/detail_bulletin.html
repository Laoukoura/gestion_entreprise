{% extends 'gestion_paie/base.html' %}

{% block title %}Bulletin - {{ bulletin.employe.get_nom_complet }}{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-12">
        <a href="{% url 'liste_bulletins' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Retour
        </a>
        <a href="{% url 'modifier_bulletin' bulletin.pk %}" class="btn btn-warning">
            <i class="bi bi-pencil"></i> Modifier
        </a>
        <a href="{% url 'ajouter_element' bulletin.pk %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Ajouter prime/déduction
        </a>
        {% if not bulletin.paye %}
        <a href="{% url 'marquer_paye' bulletin.pk %}" class="btn btn-success">
            <i class="bi bi-check-circle"></i> Marquer comme payé
        </a>
        {% endif %}
        <a href="{% url 'supprimer_bulletin' bulletin.pk %}" class="btn btn-danger">
            <i class="bi bi-trash"></i> Supprimer
        </a>
    </div>
</div>

<!-- En-tête du bulletin -->
<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <h4><i class="bi bi-file-earmark-text"></i> Bulletin de Paie</h4>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h5>Informations employé</h5>
                <p class="mb-1"><strong>Nom complet:</strong> {{ bulletin.employe.get_nom_complet }}</p>
                <p class="mb-1"><strong>Matricule:</strong> <span class="badge bg-secondary">{{ bulletin.employe.matricule }}</span></p>
                <p class="mb-1"><strong>Poste:</strong> {{ bulletin.employe.get_poste_display }}</p>
                <p class="mb-1"><strong>Département:</strong> {{ bulletin.employe.departement }}</p>
            </div>
            <div class="col-md-6 text-end">
                <h5>Période et statut</h5>
                <p class="mb-1"><strong>Mois:</strong> {{ bulletin.mois }}</p>
                <p class="mb-1"><strong>Année:</strong> {{ bulletin.annee }}</p>
                <p class="mb-1">
                    <strong>Statut:</strong>
                    {% if bulletin.paye %}
                        <span class="badge bg-success fs-6">
                            <i class="bi bi-check-circle"></i> Payé le {{ bulletin.date_paiement|date:"d/m/Y" }}
                        </span>
                    {% else %}
                        <span class="badge bg-warning fs-6">
                            <i class="bi bi-clock"></i> En attente de paiement
                        </span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Détails de la paie -->
<div class="row">
    <div class="col-md-8">
        <!-- Salaire de base et heures sup -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5><i class="bi bi-cash"></i> Salaire de base et heures supplémentaires</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <tr>
                        <td><strong>Salaire de base</strong></td>
                        <td class="text-end"><strong>{{ bulletin.salaire_base|floatformat:0 }} FCFA</strong></td>
                    </tr>
                    {% if bulletin.heures_sup_normales > 0 %}
                    <tr>
                        <td>Heures sup. normales ({{ bulletin.heures_sup_normales }}h)</td>
                        <td class="text-end">{{ bulletin.montant_heures_sup_normales|floatformat:0 }} FCFA</td>
                    </tr>
                    {% endif %}
                    {% if bulletin.heures_sup_nuit > 0 %}
                    <tr>
                        <td>Heures sup. de nuit ({{ bulletin.heures_sup_nuit }}h)</td>
                        <td class="text-end">{{ bulletin.montant_heures_sup_nuit|floatformat:0 }} FCFA</td>
                    </tr>
                    {% endif %}
                    {% if bulletin.heures_sup_weekend > 0 %}
                    <tr>
                        <td>Heures sup. week-end ({{ bulletin.heures_sup_weekend }}h)</td>
                        <td class="text-end">{{ bulletin.montant_heures_sup_weekend|floatformat:0 }} FCFA</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>

        <!-- Primes -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5><i class="bi bi-gift"></i> Primes et avantages</h5>
            </div>
            <div class="card-body">
                {% if elements_primes %}
                <table class="table">
                    {% for element in elements_primes %}
                    <tr>
                        <td>
                            {{ element.type_element.nom }}
                            {% if element.commentaire %}
                                <br><small class="text-muted">{{ element.commentaire }}</small>
                            {% endif %}
                        </td>
                        <td class="text-end">{{ element.montant|floatformat:0 }} FCFA</td>
                        <td>
                            <a href="{% url 'supprimer_element' element.pk %}" class="btn btn-sm btn-danger">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                    <tr class="table-light">
                        <td><strong>Total primes</strong></td>
                        <td class="text-end"><strong>{{ bulletin.total_primes|floatformat:0 }} FCFA</strong></td>
                        <td></td>
                    </tr>
                </table>
                {% else %}
                <p class="text-muted">Aucune prime ajoutée</p>
                {% endif %}
            </div>
        </div>

        <!-- Déductions -->
        <div class="card mb-4">
            <div class="card-header bg-warning">
                <h5><i class="bi bi-dash-circle"></i> Déductions</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <tr>
                        <td>Cotisation sociale employé</td>
                        <td class="text-end">{{ bulletin.cotisation_sociale_employe|floatformat:0 }} FCFA</td>
                    </tr>
                    <tr>
                        <td>Impôt sur le revenu</td>
                        <td class="text-end">{{ bulletin.impot_revenu|floatformat:0 }} FCFA</td>
                    </tr>
                    {% for element in elements_deductions %}
                    <tr>
                        <td>
                            {{ element.type_element.nom }}
                            {% if element.commentaire %}
                                <br><small class="text-muted">{{ element.commentaire }}</small>
                            {% endif %}
                        </td>
                        <td class="text-end">{{ element.montant|floatformat:0 }} FCFA</td>
                        <td>
                            <a href="{% url 'supprimer_element' element.pk %}" class="btn btn-sm btn-danger">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                    <tr class="table-light">
                        <td><strong>Total déductions</strong></td>
                        <td class="text-end"><strong>{{ bulletin.total_deductions|floatformat:0 }} FCFA</strong></td>
                        <td></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- Résumé -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5><i class="bi bi-calculator"></i> Résumé</h5>
            </div>
            <div class="card-body">
                <div class="mb-3 p-3 bg-light rounded">
                    <h6>Salaire brut</h6>
                    <h3 class="text-primary">{{ bulletin.salaire_brut|floatformat:0 }} FCFA</h3>
                </div>
                
                <div class="mb-3 p-3 bg-light rounded">
                    <h6>Salaire imposable</h6>
                    <h4>{{ bulletin.salaire_imposable|floatformat:0 }} FCFA</h4>
                </div>
                
                <div class="mb-3 p-3 bg-success text-white rounded">
                    <h6>Salaire net à payer</h6>
                    <h2>{{ bulletin.salaire_net|floatformat:0 }} FCFA</h2>
                </div>

                <hr>

                <div class="mb-2">
                    <small class="text-muted">Cotisation employeur</small><br>
                    <strong>{{ bulletin.cotisation_sociale_employeur|floatformat:0 }} FCFA</strong>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h6><i class="bi bi-clock-history"></i> Métadonnées</h6>
            </div>
            <div class="card-body">
                <small>
                    <strong>Créé le:</strong><br>
                    {{ bulletin.date_creation|date:"d/m/Y à H:i" }}
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}